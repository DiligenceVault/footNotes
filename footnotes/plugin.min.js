var replaceTmpl=function(t,n){var e=t;for(var o in n)e=e.replace("{"+o+"}",n[o]);return e};tinymce.PluginManager.add("footnotes",function(t){function n(){var n=t.selection.getNode(),e="",o="SPAN"==n.tagName&&"fnoteWrap"===t.dom.getAttrib(n,"class"),a=function(){if("fnoteWrap"==n.className){var t=n.childNodes[0].firstChild.nodeValue.replace(/[^0-9]/g,"");return t}return n.childNodes[0]}();o&&(e=n.name||decodeURIComponent(n.childNodes[0].getAttribute("data-content"))||""),t.windowManager.open({title:"Insert a contents",id:"footnote-dialog",body:{type:"textbox",name:"name",multiline:!0,minWidth:520,minHeight:100,value:e},onSubmit:function(n){function e(t){function n(t,n){for(var a=e(n);0!==a.length;){var r=o(t,a);if(null!==r)return r;a=e(a)}return a}function e(t){return t.nextAll().find(".fnoteBtn").length>0?t.next().hasClass("fnoteBtn")?t.next().children().children():t.nextAll().find(".fnoteBtn"):"BODY"==t.prop("nodeName")?[]:e(t.parent())}function o(t,n){if(!n)return!1;if(n)return n;var e=null;return n.children().each(function(){n&&(e=o(t,$(this)))}),e}var a=n(".fnoteBtn",t);return a}var o,r=n.data.name,i=function(){return encodeURIComponent(r)}(),l='<span class="fnoteWrap" id="#wk_ft{FOOTNOTE_INDEX}" contenteditable="false"><button type="button" class="fnoteBtn" data-content="'+i+'">{FOOTNOTE_INDEX}</button></span>&nbsp;',c=t.getDoc().querySelectorAll(".fnoteBtn"),f=c.length,s=e($(t.selection.getRng().endContainer));if(s.length){s=s[0];var d;for(d=0;d<f&&s!=c[d];d++);a<f?o=replaceTmpl(l,{FOOTNOTE_INDEX:$(c[a-1]).html()}):(o=replaceTmpl(l,{FOOTNOTE_INDEX:$(c[d]).html()}),t.selection.collapse(0))}else o=replaceTmpl(l,{FOOTNOTE_INDEX:f+1}),t.selection.collapse(0);t.execCommand("mceInsertContent",!1,o),$(t.getDoc()).find(".fnoteBtn").each(function(t){$(this).text(t+1),$(this).parent().attr("id","#wk_ft"+(t+1))})}})}t.addCommand("mceFootnotes",n),t.addButton("footnotes",{title:"footnote",image:tinyMCE.baseURL+"/plugins/footnotes/img/footnotes.png",onclick:n,stateSelector:"span.fnoteWrap"})});