var replaceTmpl=function(t,e){var n=t;for(var o in e)n=n.replace("{"+o+"}",e[o]);return n};tinymce.PluginManager.add("footnotes",function(t){function e(){var e=t.selection.getNode(),n="",o="SPAN"==e.tagName&&"wiki-fnote"===t.dom.getAttrib(e,"class"),i=function(){if("wiki-fnote"==e.className){var t=e.childNodes[0].firstChild.nodeValue.replace(/[^0-9]/g,"");return t}return e.childNodes[0]}();o&&(n=e.name||decodeURIComponent(e.childNodes[0].getAttribute("data-content"))||""),t.windowManager.open({title:"Add a footnote",id:"footnote-dialog",body:{type:"textbox",name:"name",multiline:!0,minWidth:520,minHeight:100,value:n},onSubmit:function(e){function n(t){function e(t,e){for(var i=n(e);0!=i.length;){var a=o(t,i);if(null!=a)return a;i=n(i)}return i}function n(t){return t.nextAll().find(".wiki-fnotepop").length>0?t.next().hasClass("wiki-fnotepop")?t.next().children().children():t.nextAll().find(".wiki-fnotepop"):"BODY"==t.prop("nodeName")?[]:n(t.parent())}function o(t,e){if(!e)return!1;if(e)return e;var n=null;return e.children().each(function(){e&&(n=o(t,$(this)))}),n}var i=e(".wiki-fnotepop",t);return i}var o,a=e.data.name,l=function(){return encodeURIComponent(a)}(),r='<span data-cls="foot" class="wiki-fnote" id="#wk_ft{FOOTNOTE_INDEX}" contentEditable="false"><button class="wiki-fnotepop" data-container=".wiki-fnote"  data-placement="auto bottom" data-content="'+l+'">{FOOTNOTE_INDEX}</button></span>&nbsp;',c=t.getDoc().querySelectorAll(".wiki-fnotepop"),f=c.length,d=n($(t.selection.getRng().endContainer));if(d.length){d=d[0];var p;for(p=0;p<f&&d!=c[p];p++);i<f?o=replaceTmpl(r,{FOOTNOTE_INDEX:$(c[i-1]).html()}):(o=replaceTmpl(r,{FOOTNOTE_INDEX:$(c[p]).html()}),t.selection.collapse(0))}else o=replaceTmpl(r,{FOOTNOTE_INDEX:f+1}),t.selection.collapse(0);t.execCommand("mceInsertContent",!1,o),$(t.getDoc()).find(".wiki-fnotepop").each(function(t){$(this).text(t+1),$(this).parent().attr("id","#wk_ft"+(t+1))})}})}t.addCommand("mceFootnotes",e),t.addButton("footnotes",{title:"footnote",image:tinyMCE.baseURL+"/plugins/footnotes/img/footnotes.png",onclick:e,stateSelector:"span.wiki-fnote"})});