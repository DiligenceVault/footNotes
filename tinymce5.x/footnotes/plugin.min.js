!function(){"use strict";var t=tinymce.util.Tools.resolve("tinymce.PluginManager");"function"!=typeof Array.prototype.forEach&&(Array.prototype.forEach=function(t){for(var e=0;e<this.length;e++)t.apply(this,[this[e],e,this])}),Object.defineProperty&&Object.getOwnPropertyDescriptor&&Object.getOwnPropertyDescriptor(Element.prototype,"textContent")&&!Object.getOwnPropertyDescriptor(Element.prototype,"textContent").get&&(e=Object.getOwnPropertyDescriptor(Element.prototype,"innerText"),Object.defineProperty(Element.prototype,"textContent",{get:function(){return e.get.call(this)},set:function(t){return e.set.call(this,t)}}));var e,n=function(t,e){var n=t;for(var o in e)n=n.replace(/\{(\/?[^\}]+)\}/gm,e[o]);return n},o={open:function(t){var e=t.selection.getNode(),o="",r="SPAN"==e.tagName&&"fnoteWrap"===t.dom.getAttrib(e,"class"),i="fnoteWrap"!=e.className?e.childNodes[0]:e.childNodes[0].firstChild.nodeValue.replace(/[^0-9]/g,"");r&&(o=e.name||decodeURIComponent(e.childNodes[0].getAttribute("data-content"))||""),t.windowManager.open({title:"Insert a Footnote",size:"normal",body:{type:"panel",items:[{type:"textarea",name:"name",multiline:!0,minWidth:520,minHeight:100},]},buttons:[{type:"cancel",name:"cancel",text:"Cancel"},{type:"submit",name:"save",text:"Save",primary:!0},],initialData:{name:o},onSubmit:function(e){var o,r,a,l,c,s=e.getData().name,f=encodeURIComponent(s),u='<span class="fnoteWrap" id="#wk_ft{FOOTNOTE_INDEX}" contenteditable="false"><sup class="fnoteBtn" title="'+s+'" data-content="'+f+'">{FOOTNOTE_INDEX}</sup></span>&nbsp;',p=t.getDoc().querySelectorAll(".fnoteBtn"),d=p.length,g=(a=t.selection.getNode(),l=function(t){var e,n=!1;return(n=[].filter.call(t.parentNode.children,function(e){return e.previousElementSibling===t?n=!0:n})).map(n=>Array.from(n.querySelectorAll("fnoteBtn").length)>0?e=t.nextElementSibling.classList.contains("fnoteBtn")?t.nextElementSibling.children.children:n.querySelectorAll(".fnoteBtn"):"BODY"===t.nodeName?[]:l(t.parentNode))},c=function(t,e){if(!e)return!1;if(e)return e;var n=null;return e.children.forEach(function(){e&&(n=c(t,this))}),n},function(t,e){for(var n=l(e);0!==n.length;){var o=c(t,n);if(null!==o)return o;n=l(n)}return n}(".fnoteBtn",a));if(g.length){for(o=0,g=g[0];o<d&&g!=p[o];o++);i<d?r=n(u,{FOOTNOTE_INDEX:$(p[i-1]).html()}):(r=n(u,{FOOTNOTE_INDEX:$(p[o]).html()}),t.selection.collapse(0))}else r=n(u,{FOOTNOTE_INDEX:d+1}),t.selection.collapse(0);t.execCommand("mceInsertContent",!1,r),e.close(),Array.from(t.getDoc().querySelectorAll(".fnoteBtn")).forEach(function(t,e){t.textContent=e+1,t.parentNode.setAttribute("id","#wk_ft"+(e+1))})}})}},r={register:function(t){t.addCommand("footnotes",function(){o.open(t)})}},i={register:function(t){t.ui.registry.addToggleButton("footnotes",{icon:"fnote",tooltip:"Insert a Footnote",onAction:function(){return t.execCommand("footnotes")},onSetup:function(e){return t.selection.selectorChangedWithUnbind("span.fnoteWrap",e.setActive).unbind}}),t.ui.registry.addMenuItem("footnotes",{icon:"fnote",onAction:function(){return t.execCommand("footnotes")}})}};t.add("footnotes",function(t){t.ui.registry.addIcon("fnote",'<img src="'+tinyMCE.baseURL+'/plugins/footnotes/img/fn.png" aria-label="footnote" title="footnote" role="button">'),r.register(t),i.register(t)})}();