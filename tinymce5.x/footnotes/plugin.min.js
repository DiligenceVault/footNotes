!function(){"use strict";var t=tinymce.util.Tools.resolve("tinymce.PluginManager"),n=function(t,n){var e=t;for(var o in n)e=e.replace(/\{(\/?[^\}]+)\}/gm,n[o]);return e},e=function(t){var e=t.selection.getNode(),o="",i="SPAN"==e.tagName&&"fnoteWrap"===t.dom.getAttrib(e,"class"),a="fnoteWrap"==e.className?e.childNodes[0].firstChild.nodeValue.replace(/[^0-9]/g,""):e.childNodes[0];i&&(o=e.name||decodeURIComponent(e.childNodes[0].getAttribute("data-content"))||""),t.windowManager.open({title:"Insert Contents",size:"normal",body:{type:"panel",items:[{type:"textarea",name:"name",multiline:!0,minWidth:520,minHeight:100}]},buttons:[{type:"cancel",name:"cancel",text:"Cancel"},{type:"submit",name:"save",text:"Save",primary:!0}],initialData:{name:o},onSubmit:function(e){var o,i=e.getData().name,r='<span class="fnoteWrap" id="#wk_ft{FOOTNOTE_INDEX}" contenteditable="false"><button type="button" class="fnoteBtn" data-content="'+encodeURIComponent(i)+'">{FOOTNOTE_INDEX}</button></span>',c=t.getDoc().querySelectorAll(".fnoteBtn"),l=c.length;console.log(t.selection.getRng().endContainer);var s,f,u,d=(s=$(t.selection.getRng().endContainer),f=function(t){return t.nextAll().find(".fnoteBtn").length>0?t.next().hasClass("fnoteBtn")?t.next().children().children():t.nextAll().find(".fnoteBtn"):"BODY"==t.prop("nodeName")?[]:f(t.parent())},u=function(t,n){if(!n)return!1;if(n)return n;var e=null;return n.children().each(function(){n&&(e=u(t,$(this)))}),e},function(t,n){for(var e=f(n);0!==e.length;){var o=u(t,e);if(null!==o)return o;e=f(e)}return e}(".fnoteBtn",s));if(d.length){var m;for(d=d[0],m=0;m<l&&d!=c[m];m++);a<l?o=n(r,{FOOTNOTE_INDEX:$(c[a-1]).html()}):(o=n(r,{FOOTNOTE_INDEX:$(c[m]).html()}),t.selection.collapse(0))}else o=n(r,{FOOTNOTE_INDEX:l+1}),t.selection.collapse(0);t.execCommand("mceInsertContent",!1,o),e.close(),$(t.getDoc()).find(".fnoteBtn").each(function(t){$(this).text(t+1),$(this).parent().attr("id","#wk_ft"+(t+1))})}})},o={register:function(t){t.addCommand("footnotes",function(){e(t)})}},i={register:function(t){t.ui.registry.addToggleButton("footnotes",{icon:"fnote",tooltip:"Footnote",onAction:function(){return t.execCommand("footnotes")},onSetup:function(n){return t.selection.selectorChangedWithUnbind("span.fnoteWrap",n.setActive).unbind}}),t.ui.registry.addMenuItem("footnotes",{icon:"fnote",onAction:function(){return t.execCommand("footnotes")}})}};t.add("footnotes",function(t){t.ui.registry.addIcon("fnote",'<img src="'+tinyMCE.baseURL+'/plugins/footnotes/img/fn.png">'),o.register(t),i.register(t)})}();